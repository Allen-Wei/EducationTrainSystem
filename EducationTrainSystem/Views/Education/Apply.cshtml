@{
    ViewBag.Title = "申请";
    Layout = "~/Views/Shared/_Education.cshtml";
}

@section header{

    <style type="text/css">
        input[type=radio] { -webkit-appearance: radio; }
        input[type=checkbox] { -webkit-appearance: checkbox; }
        .form-control[readonly] { background-color: white; }
        .tip { margin-left: -30px; position: fixed; z-index: 100; background-color: rgba(30, 30, 30, 0.3); width: 100%; padding: 0 8px; top: 50px; min-height: 30px; line-height: 30px; }
        .ellipsis { display: inline-block; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        .ellipsis-base { text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        .ng-hide, .hide { display: none; }
        .edu-inline { display: inline-block; width: auto; }
        .input-group .form-control { z-index: 1; }

        .top10 { margin-top: 10px; }
        .bottom10 { margin-bottom: 10px; }

        .new-form .col-xs-12 { margin-top: 10px; vertical-align: middle; }
        /*for form.html, detai.html*/
        .header-sub { color: #aaa; }

        input.ng-dirty.ng-invalid { border: 1px solid red; }
    </style>
}


<div class="container-fluid" ng-app="Registration">
    <div ng-controller="BodyCtrl">
        <div class="row" ng-controller="AddCtrl">

            <form class="new-form" role="form" name="NewForm" novalidate>
                <div class="row">
                    <div class="col-sm-6 col-xs-12">

                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                基本信息
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <!-- Registrater Information -->
                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        报名日期
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <input type="text"
                                               class="form-control"
                                               select-date
                                               date-format="{{constant.uiDateFormat}}"
                                               ng-model="main.user.RegDate"
                                               required />
                                    </div>

                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        姓名
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <input type="text" value="" class="form-control" ng-model="main.user.Name" placeholder="学员姓名" required />
                                    </div>

                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        性别
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <label>
                                            <input type="radio" ng-checked="main.user.Gender" ng-click="main.user.Gender = true" /> 男
                                        </label>
                                        <label>
                                            <input type="radio" ng-checked="!main.user.Gender" ng-click="main.user.Gender = false" /> 女
                                        </label>
                                    </div>

                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        身份证号
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <input type="text" value="" class="form-control" ng-model="main.user.CardId" placeholder="学员身份证号码" required />
                                    </div>

                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        民族
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <input type="text" value="" class="form-control" ng-model="main.user.Nation" placeholder="学员所属民族" required />
                                    </div>

                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        电话
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <input type="text" value="" class="form-control" ng-model="main.user.Phone" placeholder="学员联系电话" required />
                                    </div>

                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        备用电话
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <input type="text" value="" class="form-control" placeholder="学员备用电话" ng-model="main.user.Phone2" />
                                    </div>

                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        户籍
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <input type="text" value="" class="form-control" placeholder="学员户籍地址" ng-model="main.user.HomeAddress" required />
                                    </div>
                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        住址
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <input type="text" value="" class="form-control" placeholder="学员住址" ng-model="main.user.LiveAddress" required />
                                    </div>

                                    <!-- Registration Information-->
                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        课程类别
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <select class="form-control"
                                                ng-model="main.assist.train"
                                                ng-options="cc.Description for cc in main.assist.trains"></select>
                                    </div>

                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        所报课程
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <select class="form-control"
                                                ng-options="c.Description for c in main.assist.courses"
                                                ng-model="main.assist.course"></select>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>



                    <div class="col-sm-6 col-xs-12">

                        <div class="panel panel-info" ng-show="main.assist.train.Category == 'EduTrains'">
                            <div class="panel-heading">学历教育培训</div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        所报院校
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <select class="form-control" ng-model="main.assist.regCollege" ng-options="college.Name for college in main.assist.regColleges"></select>
                                    </div>
                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        所报专业
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <input type="text" value="" class="form-control" placeholder="学员所报专业" ng-model="main.eduTrain.RegMajor" />
                                    </div>

                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        学历类别
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <select class="form-control" ng-model="main.eduTrain.EduType">
                                            <option value="专科">专科</option>
                                            <option value="本科">本科</option>
                                        </select>
                                    </div>
                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        所在学校
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <select class="form-control" ng-options="college.Name for college in main.assist.currentColleges" ng-model="main.assist.currentCollege"></select>
                                    </div>
                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        所在年级
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <input type="text" class="form-control" ng-model="main.eduTrain.CurrentGrade" />
                                    </div>

                                </div>
                            </div>
                        </div>

                        <div class="panel panel-info" ng-show="main.assist.train.Category == 'CertificationTrains'">
                            <div class="panel-heading">资格证培训</div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        所在院校
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <select class="form-control" ng-options="college.Name for college in main.assist.currentColleges" ng-model="main.assist.currentCollege"></select>
                                    </div>
                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        所在年级
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <select class="form-control" ng-model="main.certTrain.CurrentGrade">
                                            <option value="大一">大一</option>
                                            <option value="大二">大二</option>
                                            <option value="大三">大三</option>
                                            <option value="大四">大四</option>
                                        </select>
                                    </div>
                                    <div class="col-sm-3 col-xs-12 header-sub">
                                        学历类别
                                    </div>
                                    <div class="col-sm-9 col-xs-12">
                                        <select class="form-control" ng-model="main.certTrain.EduType">
                                            <option value="专科">专科</option>
                                            <option value="本科">本科</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>

                </div>

                <div class="row">
                    <div class="col-sm-12">
                        <button ng-click="main.submit()" class="btn btn-default" ng-disabled="NewForm.$invalid">Submit</button>
                    </div>
                </div>

            </form>


        </div>
    </div>

</div>
<script>
    amplify.publish('path.refresh', [{
        href: '/', text: '首页'
    }, {
        text: '报名申请'
    }]);

    var app = angular.module('Registration', [
        'ngRoute',
        'edu.directives',
        'edu.filters',
        'edu.services.global',
        'edu.services.regentity',
        'edu.services.reg',
        'edu.services.train',
        'edu.services.course',
        'edu.services.keyvalue',
        'edu.services.keyvaluegroup',
        'edu.services.keyvaluematch',
        'edu.services.edutrain'
    ]);
    app.controller('BodyCtrl', function ($scope, AppConstant, $location) {
        $scope.constant = AppConstant;
    });


    app.controller('AddCtrl', function (
    $scope,
    $filter,
    $location,
    AppConstant,
    KeyValueSvc,
    RegEntitySvc,
    RegSvc,
    TrainSvc,
    CourseSvc,
    EduTrainSvc) {

        $scope.main = {
            user: {
                RegDate: $filter('date')(new Date(), AppConstant.ngDateFormat),
                Name: '',
                Nation: '汉',
                Gender: true,
                CardId: '',
                Phone: '',
                Phone2: '',
                LiveAddress: '',
                HomeAddress: '',
            },
            reg: {
                ReceiptNumber: '',
                Price: 0,
                Agent: '',
                Payee: '',
                Note: '',
                Confirmed: true,
                Address: ''
            },
            eduTrain: {
                Course: '',
                RegCollege: '',
                RegMajor: '',
                EduType: '专科',
                CurrentCollege: '',
                CurrentGrade: '大一'
            },
            certTrain: {
                Course: '',
                CurrentCollege: '',
                CurrentGrade: '大一',
                EduType: '专科'
            },

            submit: function () {
                var trainCategory = (this.assist.train || {})['Category'];
                if (!trainCategory) { throw 'Invalid train category at AddCtrl -> submit'; return; }
                this.reg.Address = this.assist.regAddress.Name;

                var train = undefined;
                //学历教育
                if (trainCategory == 'EduTrains') {
                    this.eduTrain.Course = this.assist.course.Name;
                    this.eduTrain.RegCollege = this.assist.regCollege.Name;
                    this.eduTrain.CurrentCollege = this.assist.currentCollege.Name;
                    train = this.eduTrain;
                }
                //资格证培训
                if (trainCategory == 'CertificationTrains') {
                    this.certTrain.Course = this.assist.course.Name;
                    this.certTrain.CurrentCollege = this.assist.currentCollege.Name;
                    train = this.certTrain;
                }

                if (train == undefined) { throw 'error train at AddCtrl -> add'; }
                train['Category'] = trainCategory;

                var promise = RegEntitySvc.apply(this.reg, this.user, train);
                promise.then(function (rep) {
                    if (rep.data) {
                        $location.path('/Education/ApplySuccess?key=' + rep.data.gid);
                    }
                });
            },

            assist: {
                trains: [],
                train: {},
                courses: [],
                course: {},
                regAddresses: [],
                regAddress: {},
                currentColleges: [],
                currentCollege: {},
                regColleges: [],
                regCollege: {}
            }
        };


        TrainSvc.getAll().then(function (rep) {
            $scope.main.assist.trains = rep.data;
            $scope.main.assist.train = $scope.main.assist.trains[0];
        });

        //load courses
        $scope.$watch('main.assist.train.Id', function (newVal, oldVal) {
            if (!newVal) { return; }
            CourseSvc.getByTrain(newVal).then(function (rep) {
                $scope.main.assist.courses = rep.data;
                $scope.main.assist.course = $scope.main.assist.courses[0];
            });
        });
        //load registration address
        RegSvc.loadRegAddresses().then(function (rep) {
            $scope.main.assist.regAddresses = rep.data;
            $scope.main.assist.regAddress = $scope.main.assist.regAddresses[0];
        });
        //load all colleges
        RegSvc.loadAllColleges().then(function (rep) {
            $scope.main.assist.currentColleges = rep.data;
            $scope.main.assist.currentCollege = $scope.main.assist.currentColleges[0];
        });
        //load registration college
        $scope.$watch('main.assist.course.Name', function (newVal, oldVal) {
            if (!newVal) { return; }
            KeyValueSvc.getByGroup(newVal).then(function (rep) {
                if (!rep.data) {
                    rep.data = [{}];
                }
                $scope.main.assist.regColleges = rep.data;
                $scope.main.assist.regCollege = $scope.main.assist.regColleges[0];
            });;
        });
    });


    amplify.publish('path.refresh', [{ href: '/', text: '首页' }, { text: '报名申请' }]);
</script>
